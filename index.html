<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Game Over</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>    
    


    <style type="text/css" media="screen, print">
        @font-face {
          font-family: "VCR";
          src: url("assets/VCR_OSD_MONO.ttf") format("truetype");
        }
    </style>

    <div style="font-family: VCR;">.</div>

</head>
 
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color:black;
    }
</style>

    


<script type="text/javascript">

var gameScene = new Phaser.Scene('gameScene');
var titleScene = new Phaser.Scene('titleScene');
var animateScene = new Phaser.Scene('animateScene')

        var config = {
            type: Phaser.AUTO,
            width: 970,
            height: 686,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 500 },
                    debug: false
                }
            },
            audio: {
            disableWebAudio: true //web audio doesn't play with silent mode on
            },
            scale: {
                mode: Phaser.Scale.HEIGHT_CONTROLS_WIDTH, //Works in portrait and landscape
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            scene: [titleScene, animateScene, gameScene]
        };
    
        var game = new Phaser.Game(config);
        var player;
        var platforms;
        var cursors;
        var text;
        var sky;
        var mountains;
        var skylineBack;
        var skylineMid;
        var skylineFront;
        var ground;
        var pressed = false;
        var i = 0;
        var d = 50;
        var loaded = false;
        var waited = false;
        var playButton;
        var playing = false;

        game.scene.start(titleScene);


        titleScene.preload = function()
        {
    
            this.load.audio('song', 'assets/game-over.mp3');
            this.load.image('sky', 'assets/Sky2.png');
            this.load.image('mountains', 'assets/Mountains2.png')
            this.load.image('skyline-back', 'assets/skyline-back.png');
		    this.load.image('skyline-mid', 'assets/Mid2.png');
		    this.load.image('skyline-front', 'assets/Front2.png'); 
            this.load.image('ground', 'assets/Ground2.png'); 
            this.load.spritesheet('dude', 'assets/spritesheet.png', { frameWidth: 34, frameHeight: 34 });

            this.load.on('complete', function () {
                loaded = true;
            });
    
        }

        titleScene.create = function () {
            this.music = this.sound.add('song');

            sky = this.add.image(0, 0, 'sky').setOrigin(0,0);
            sky.alpha = 0;

            mountains = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'mountains').setOrigin(0, 0);
            skylineBack = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'skyline-back').setOrigin(0, 0);
            skylineMid= this.add.tileSprite(0, game.config.height, game.config.width, 362, 'skyline-mid').setOrigin(0, 0);
            skylineFront = this.add.tileSprite(0, game.config.height, game.config.width, 232, 'skyline-front').setOrigin(0, 0);
            ground = this.add.tileSprite(0, game.config.height, game.config.width, 96, 'ground').setOrigin(0, 0);

            playButton = this.add.text(game.config.width / 2, 200, 'PLAYY', { fontFamily: "VCR", fontSize: '50pt'}).setOrigin(0.35, 0.5);
            playButton.setInteractive({ useHandCursor: true });
            playButton.visible = false;

            async function wait() {
                await timer(2000);
                waited = true;
                playButton.visible = true;
                }
            wait();

            playButton.on('pointerdown', () => { 
                if (document.readyState === "complete" && loaded === true && waited === true) {
                    playButton.visible = false;
                    this.music.play();

                    this.time.addEvent({ delay: 32, callback: checkPlaying, callbackScope: this, loop: true });
                         
                }
            });
        }

        animateScene.update = function() {
            if (i < d) {
                mountains.y -= game.config.height / d;
                skylineBack.y -= game.config.height / d;
                skylineMid.y -= (392 + 96) / d;
                skylineFront.y -= (232 + 96) / d;
                ground.y -= 96 / d;

                i += 1;
            } else {
                this.scene.pause(animateScene);
                this.scene.launch(gameScene);
            }
        }

        function timer(ms) {
                return new Promise(res => setTimeout(res, ms));
                }

        

        gameScene.update = function() { //60 normal, will only run 30 times per second in low power mode

                var currentTime = new Date(); 
                var elapsed = (currentTime.getTime() - this.startTime.getTime()) / 16; //Use time elapsed since start as index to update scroll positions so will move at the same speed in 60 and 30 fps.
                mountains.tilePositionX = 0.2 * elapsed;
                skylineBack.tilePositionX = 0.4 * elapsed;
                skylineMid.tilePositionX = 0.5 * elapsed;
                skylineFront.tilePositionX = 0.7 * elapsed;  
                ground.tilePositionX = 1.4 * elapsed;
        }


        gameScene.create = function()
        {
            
            this.startTime = new Date();
            //this.physics.world.setFPS(30);
            player = this.physics.add.sprite((game.config.width / 2) - 80, 200, 'dude').setScale(1.5);
            player.setBounce(0.4);
            player.setCollideWorldBounds(true);
            this.physics.add.existing(ground, true);
            this.physics.add.collider(player, ground);

            
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 2 }),
                frameRate: 7.5,
                repeat: -1
            });


            player.anims.play('right');
        
            this.initialTime = 180;
    
            text = this.add.text(game.config.width / 2, 32, formatTime(this.initialTime), { fontFamily: "VCR", fontSize: '16pt' });


            this.time.addEvent({ delay: 1000, callback: timerEvent, callbackScope: this, loop: true });

            this.input.on('pointerdown', function(){
            player.setVelocityY(-300);
            });
            
            
            
            
        }   
    
        function checkPlaying() {
            if (this.music.isPlaying === true) {
                            this.time.removeAllEvents();
                            this.time.addEvent({ delay: 8000, callback: showSky, callbackScope: this, loop: false });
                            this.scene.launch(animateScene); //Don't stop title scene, this will stop timers
                    }
        }
    
        function formatTime(seconds)
        {
            var minutes = Math.floor(seconds/60);
            var partInSeconds = seconds%60;
            partInSeconds = partInSeconds.toString().padStart(2,'0');
            return `${minutes}:${partInSeconds}`;
        }
    
    
        function timerEvent ()
        {
            if (this.initialTime == 0)
            {
                this.time.removeAllEvents();
            } else {
        
            this.initialTime -= 1; // One second
            text.setText(formatTime(this.initialTime));
            }
        }

        

        

        function showSky () {
            async function fade() {
            while (sky.alpha < 1) {
                sky.alpha += 0.1;
                await timer(30);
            };
        }
        fade();
        }


    
    
    </script>
    
    </body>
    </html>