<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Game Over</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>    
    


    <style type="text/css" media="screen, print">
        @font-face {
          font-family: "VCR";
          src: url("assets/VCR_OSD_MONO.ttf") format("truetype");
        }
    </style>

    <div style="font-family: VCR;">.</div>

</head>
 
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color:black;
    }
</style>

    


<script type="text/javascript">

var gameScene = new Phaser.Scene('gameScene');
var titleScene = new Phaser.Scene('titleScene');


        var config = {
            type: Phaser.CANVAS,
            width: 970,
            height: 686,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 500 },
                    debug: false
                }
            },
            audio: {
            disableWebAudio: true
            },
            scale: {
                mode: Phaser.Scale.HEIGHT_CONTROLS_WIDTH,
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            scene: [titleScene, gameScene]
        };
    
        var game = new Phaser.Game(config);
        var player;
        var platforms;
        var cursors;
        var text;
        var sky;
        var mountains;
        var skylineBack;
        var skylineMid;
        var skylineFront;
        var ground;
        var playButton;
        var pressed = false;
        var i = 0;
        var d = 50;
        var loaded = false;
        var waited = false;
        var title = true;


        game.scene.start(titleScene);


        titleScene.preload = function()
        {
    
            this.load.audio('song', 'assets/game-over.mp3');
            this.load.image('sky', 'assets/Sky2.png');
            this.load.image('mountains', 'assets/Mountains2.png')
            this.load.image('skyline-back', 'assets/skyline-back.png');
		    this.load.image('skyline-mid', 'assets/Mid2.png');
		    this.load.image('skyline-front', 'assets/Front2.png'); 
            this.load.image('ground', 'assets/Ground2.png'); 
            this.load.spritesheet('dude', 'assets/spritesheet.png', { frameWidth: 34, frameHeight: 34 });

            this.load.on('complete', function () {
                loaded = true;
            });
    
        }

        titleScene.create = function() {

            async function titleSceneUpdate() {
                while (title === true) {
                if (pressed == true && i < d) {
                
                mountains.y -= game.config.height / d;
                skylineBack.y -= game.config.height / d;
                skylineMid.y -= (392 + 96) / d;
                skylineFront.y -= (232 + 96) / d;
                ground.y -= 96 / d;

                i += 1;
            } else if (pressed == true){
                title = false;
                titleScene.scene.pause(titleScene);
                titleScene.scene.launch(gameScene);
            }
                await timer(16);
        }
            }
            titleSceneUpdate();


            var music = this.sound.add('song');

            sky = this.add.image(0, 0, 'sky').setOrigin(0,0);
            sky.alpha = 0;

            mountains = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'mountains').setOrigin(0, 0);
            skylineBack = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'skyline-back').setOrigin(0, 0);
            skylineMid= this.add.tileSprite(0, game.config.height, game.config.width, 362, 'skyline-mid').setOrigin(0, 0);
            skylineFront = this.add.tileSprite(0, game.config.height, game.config.width, 232, 'skyline-front').setOrigin(0, 0);
            ground = this.add.tileSprite(0, game.config.height, game.config.width, 96, 'ground').setOrigin(0, 0);
    
            playButton = this.add.text(game.config.width / 2, 200, 'PLAY!!', { fontFamily: "VCR", fontSize: '50pt'}).setOrigin(0.35, 0.5);
            playButton.setInteractive({ useHandCursor: true });
            playButton.visible = false;

            async function wait() {
                await timer(2000);
                waited = true;
                playButton.visible = true;
                }
            wait();

            playButton.on('pointerdown', () => { 
                if (document.readyState === "complete" && loaded === true && waited === true) {
                    music.play();
                    playButton.visible = false;
                    pressed = true;
                }
            });
            

        };


        function timer(ms) {
                return new Promise(res => setTimeout(res, ms));
                }


        gameScene.create = function()
        {
            async function gameSceneUpdate () {
                while (true === true) {
                mountains.tilePositionX += 0.2;
                skylineBack.tilePositionX += 0.4;
                skylineMid.tilePositionX += 0.5;
                skylineFront.tilePositionX += 0.7;  
                ground.tilePositionX += 1.4;
                await timer(16);
                }
            }
            gameSceneUpdate();


            this.time.addEvent({ delay: 7000, callback: showSky, callbackScope: this, loop: false });

            player = this.physics.add.sprite((game.config.width / 2) - 80, 320, 'dude').setScale(1.5);
            player.setBounce(0.4);
            player.setCollideWorldBounds(true);
            this.physics.add.existing(ground, true);
            this.physics.add.collider(player, ground);

            
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 2 }),
                frameRate: 7.5,
                repeat: -1
            });


            player.anims.play('right');
        
            this.initialTime = 180;
    
            text = this.add.text(game.config.width / 2, 32, formatTime(this.initialTime), { fontFamily: "VCR", fontSize: '16pt' });


            this.time.addEvent({ delay: 1000, callback: timerEvent, callbackScope: this, loop: true });

            this.input.on('pointerdown', function(){
            player.setVelocityY(-400);
            });

            
            
            
        }   
    
        
    
        function formatTime(seconds)
        {
            var minutes = Math.floor(seconds/60);
            var partInSeconds = seconds%60;
            partInSeconds = partInSeconds.toString().padStart(2,'0');
            return `${minutes}:${partInSeconds}`;
        }
    
    
        function timerEvent ()
        {
            if (this.initialTime == 0)
            {
                this.time.removeAllEvents();
            } else {
        
            this.initialTime -= 1; // One second
            text.setText(formatTime(this.initialTime));
            }
        }

        

        function showSky () {
            async function fade() {
            while (sky.alpha < 1) {
                sky.alpha += 0.1;
                await timer(30);
            };
        }
        fade();
        }


    
    
    </script>
    
    </body>
    </html>