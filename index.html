<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game Over</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>  
    

    <style type="text/css" media="screen, print">
        @font-face {
          font-family: "VCR";
          src: url("assets/VCR_OSD_MONO.ttf") format("truetype");
        }
    </style>

    <!--<div style="font-family: VCR;">.</div> -->

</head>
 
<style>
    html,
    body {
        margin: 0;
        height: 100%;
        background: black;
        }
</style>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>




<body>

<div id="phaserdiv"></div>

<script type="text/javascript">

        ///////////////////////////////////////////////////////////////////////////////////

        var options = {
            gravity: 800,
            speed: 120,
            spawnRange: [70, 120],
            platformSizeRange: [120, 240],
        }

        var backgroundSpeedRatios = { 
            mountains: 0.2,
            skylineBack: 0.3,
            skylineMid: 0.4,
            skylineFront: 0.5,
        }

        //////////////////////////////////////////////////////////////////////////////////

    var bootScene = new Phaser.Scene('bootScene');
    var instructionsScene = new Phaser.Scene('instructionsScene');
    var gameScene = new Phaser.Scene('gameScene');
    var welcomeScene = new Phaser.Scene('welcomeScene');
    var animateScene = new Phaser.Scene('animateScene');
    var gameOverScene = new Phaser.Scene('gameOverScene');
    var setNameScene = new Phaser.Scene('setNameScene');
    var leaderboardScene = new Phaser.Scene('leaderboardScene');

    

        var config = {
            type: Phaser.AUTO,
            width: 970,
            height: 686,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            dom: {
            createContainer: true
            },
            audio: {
            disableWebAudio: true //web audio doesn't play with silent mode on
            },
            scale: {
                parent: "phaserdiv",
                mode: Phaser.Scale.HEIGHT_CONTROLS_WIDTH, //Works in portrait and landscape
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            scene: [bootScene, welcomeScene, instructionsScene, animateScene, gameScene, gameOverScene, setNameScene, leaderboardScene]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBkgjnXTIy4uFe76fOdMKXdcsFYrwJGEbo",
            authDomain: "game-over-7a4bb.firebaseapp.com",
            databaseURL: "https://game-over-7a4bb.firebaseio.com",
            projectId: "game-over-7a4bb",
            storageBucket: "game-over-7a4bb.appspot.com",
            messagingSenderId: "415474068057",
            appId: "1:415474068057:web:37f17b6ead89963d38df48"
};

        firebase.initializeApp(firebaseConfig);

    
        window.focus();

        var game = new Phaser.Game(config);
        var dropHeight = 200;
        var cursors;
        var text;
        var sky;
        var mountains;
        var skylineBack;
        var skylineMid;
        var skylineFront;
        var ground;
        var pressed = false;
        var loaded = false;
        var waited = false;
        var playButton;
        var playing = false;
        var tt;
        var instructions;
        var camera;
        var tsCamera;
        var scoreText;
        var score = 0;
        var fallingStars;
        var leaderBoard;
        var backButton;
        var nextPlatformDistance = new Array(3);
        var add = true;
        var added = false;
        var movePlatforms = false;
        var scaleIndex = 0.8;
        var pressedPlay = false;
        var previousTextLength = 0;
        var inputText;
        var scoresRetrieved;
        var usernameReal;
        var newUser = false;
        


        //starting scene removes just scene before. launching doesn't remove any.
        game.scene.start(bootScene);

        bootScene.preload = function() {

            this.load.audio('song', 'assets/game-over.mp3');
            this.load.image('instructions', 'assets/instructions.png');
            this.load.image('startscreen', 'assets/startscreen.png');
            this.load.image('taptostart', 'assets/taptostart.jpg');
            this.load.image('list', 'assets/list.png');
            this.load.image('ins1', 'assets/ins1.png');
            this.load.image('ins2', 'assets/ins2.png');
            this.load.image('ins3', 'assets/ins3.png');
            this.load.image('ins4', 'assets/ins4.png');
            this.load.image('sky', 'assets/Sky2.png');
            this.load.image('nightsky', 'assets/night-sky.jpeg');
            this.load.image('star', 'assets/star.png');
            this.load.image('bomb', 'assets/bomb.png');
            this.load.image('mountains', 'assets/Mountains2.png')
            this.load.image('skyline-back', 'assets/back.png');
		    this.load.image('skyline-mid', 'assets/mid-new.png');
		    this.load.image('skyline-front', 'assets/Front2.png' ); 
            this.load.image('ground', 'assets/Ground2.png'); 
            this.load.spritesheet('dude', 'assets/dude-new.png', { frameWidth: 26, frameHeight: 34 });
            this.load.spritesheet('dude-bombed', 'assets/bombed-new.png', { frameWidth: 34, frameHeight: 34 });
            this.load.image('platform', 'assets/platform-3.png');
            this.load.image('gameoversign', 'assets/gameoversign.png');
            this.load.plugin('rexfirebaseplugin', 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexfirebaseplugin.min.js', true);
            this.load.plugin('rexinputtextplugin', 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexinputtextplugin.min.js', true);
            this.load.plugin('rexgridtableplugin', 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexgridtableplugin.min.js', true);
            this.load.plugin('rexscrollerplugin', 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexscrollerplugin.min.js', true);



            this.load.on('complete', function () {
                loaded = true;
            });
        }

        bootScene.create = function() {

            

            this.add.image(0, 0, 'nightsky').setOrigin(0,0);
            sky = this.add.image(0, 0, 'sky').setOrigin(0,0);
            sky.alpha = 0;
            

            this.skyCamera = this.cameras.main;

            
            
            
            this.scene.launch(welcomeScene);
        }
        
        

        welcomeScene.create = function () {

            


            this.add.text(0, 0, '', { fontFamily: "VCR"}); //get font working

            this.startscreen = this.add.image(game.config.width / 2, game.config.height / 2, 'startscreen');
            this.taptostart = this.add.image(game.config.width / 2, 540, 'taptostart');
            this.taptostart.alpha = 0;
            this.alphaIndex = 0.04;

            async function goList() {
            var list = new Array(15);
            var keepGoing = true;
            for (x = 14; x < 29; x++) {
                list[x] = welcomeScene.add.image(game.config.width / 2, x * 17, 'list');
                list[x].visible = false;
            }
            await timer(500);
            while (keepGoing) {
            for (x = 14; x < 29; x++) {
                list[x].visible = true;
                await timer(100);
            }
            for (x = 14; x < 29; x++) {
                list[x].visible = false;
                await timer(100);
            }
            }
            }

            
            goList();

            

            function pulse() {
                this.taptostart.alpha += this.alphaIndex;
                if (this.taptostart.alpha === 1 || this.taptostart.alpha === 0) {
                    this.alphaIndex = this.alphaIndex * -1;
                }
            }
            
            // playButton = this.add.text(game.config.width / 2, 200, 'TAP TO START', { fontFamily: "VCR", fontSize: '32pt'}).setOrigin(0.5);
            this.taptostart.setInteractive({ useHandCursor: true });
            // playButton.visible = false;

            welcomeScene.wait = async function () {
                await timer(2000);
                waited = true;
                this.time.addEvent({ delay: 30, callback: pulse, callbackScope: this, loop: true });
                }
            welcomeScene.wait();

            var notPressed = true;
            this.input.on('pointerdown', () => { 
                if (document.readyState === "complete" && loaded === true && waited === true && notPressed === true) {
                    notPressed = false;
                    welcomeScene.scene.start(animateScene);
                    //welcomeScene.scene.launch(leaderboardScene);
                }
            });
        }
         

        
         animateScene.create = function() {

            tsCamera = this.cameras.main;

            mountains = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'mountains').setOrigin(0, 0);
            skylineBack = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'skyline-back').setOrigin(0, 0);
            skylineMid = this.add.tileSprite(0, game.config.height, game.config.width, game.config.height, 'skyline-mid').setOrigin(0, 0);
            skylineFront = this.add.tileSprite(0, game.config.height, game.config.width, 232, 'skyline-front').setOrigin(0, 0);
            ground = this.add.tileSprite(0, game.config.height, game.config.width, 96, 'ground').setOrigin(0, 0);

            mountains.alpha = 0.9;
            skylineBack.alpha = 0.85;
            skylineMid.alpha = 0.6;
            skylineFront.alpha = 0.95;

            //Used to set tileSprite position
            this.velocity = this.physics.add.sprite(0, 0, '');
            this.velocity.visible = false;
            this.velocity.setVelocityX(options.speed);

            this.gameStartMs = Date.now();

            async function moveUp() {
                tt = 35; // total time
                for (t = 1; t <= tt; t ++) {
                    mountains.y = distanceAtTime(game.config.height, t);
                    skylineBack.y = distanceAtTime(game.config.height, t);
                    skylineMid.y = distanceAtTime(game.config.height, t);
                    skylineFront.y = distanceAtTime((232 + 96), t);
                    ground.y = distanceAtTime(96, t);  
                    await timer(16);
                }
                //animateScene.scene.pause(animateScene);
                animateScene.scene.launch(instructionsScene);
            }
            moveUp();
        }  

        animateScene.update = function() { //60 normal (roughly every 16ms), will only run 30 times per second in low power mode - can't do incrementing

            var tsPosition = this.velocity.x;

            mountains.tilePositionX = tsPosition * backgroundSpeedRatios.mountains;
            skylineBack.tilePositionX = tsPosition * backgroundSpeedRatios.skylineBack;
            skylineMid.tilePositionX = tsPosition * backgroundSpeedRatios.skylineMid;
            skylineFront.tilePositionX = tsPosition * backgroundSpeedRatios.skylineFront; 
            ground.tilePositionX = tsPosition;
        } 


        instructionsScene.create = function() {

            this.music = this.sound.add('song');

            this.arrow = this.add.text(game.config.width / 2, 150, '→', { fontFamily: "VCR", fontSize: '32pt' }).setOrigin(0.5);
            var ins1 = this.add.image(game.config.width / 2, 100, 'ins1').setScale(0.8);
            this.alphaIndexArrow = 0.04;

            this.time.addEvent({ delay: 30, callback: pulseArrow, callbackScope: this, loop: true });

            function pulseArrow() {
                this.arrow.alpha += this.alphaIndexArrow;
                if (this.arrow.alpha === 1 || this.arrow.alpha === 0) {
                    this.alphaIndexArrow = this.alphaIndexArrow * -1;
                } 
            }



            var ins2 = this.add.image(game.config.width / 2, 100, 'ins2').setScale(0.8);
            var ins3 = this.add.image(game.config.width / 2, 100, 'ins3').setScale(0.25);
            var ins4 = this.add.image(game.config.width / 2, 100, 'ins4').setScale(0.8);
            ins2.visible = false;
            ins3.visible = false;
            ins4.visible = false;
            this.input.on('pointerdown', () => {
                ins1.visible = false;
                ins2.visible = true;
                this.input.on('pointerdown', () => {
                    ins2.visible = false;
                    ins3.visible = true;
                    this.input.on('pointerdown', () => {
                        ins3.visible = false;
                        ins4.visible = true;
                        instructionsScene.arrow.setText('PLAY');
                        instructionsScene.arrow.setScale(0.75);
                        instructionsScene.arrow.y = 170;
                        this.input.on('pointerdown', () => {
                            if (pressedPlay == false) {
                                pressedPlay = true;
                                instructionsScene.music.play();
                                this.time.addEvent({ delay: 16, callback: checkPlaying, callbackScope: this, loop: true });
                        }
            });
            });
            });
            });

            }

            
        function distanceAtTime(ts, t){ // total distance, time for distance to be found at
            var v = 0;
            var u = ts / (0.5 * tt);
            var a = (v - u) / tt;

            var s = (u * t) + (0.5 * a * t ** 2);
            return (game.config.height - s);
        }   
         

        function timer(ms) {
                return new Promise(res => setTimeout(res, ms));
                }

        

        gameScene.update = function() {
            this.player.x = 405;

            // this.starGroup.getChildren().forEach(function(star){
            //     if (star.x < - star.displayWidth / 2) {
            //         this.starGroup.killAndHide(star);
            //         this.starGroup.remove(platform);
            //     }

            // }, this);


            for (z = 0; z < 3; z++) {
            var minDistance = game.config.width;
            this.platformGroup[z].getChildren().forEach(function(platform){
                var platformDistance = game.config.width - platform.x - platform.displayWidth / 2;
                minDistance = Math.min(minDistance, platformDistance);
                if (platform.x < - platform.displayWidth / 2) {
                    this.platformGroup[z].killAndHide(platform);
                    this.platformGroup[z].remove(platform);
                }

            }, this);

            
            var platformY;
            if (z == 0) {
                platformY = 500;
            } else if (z == 1) {
                platformY = 350;
            } else if (z == 2) {
                platformY = 200;
            }

            if (minDistance > nextPlatformDistance[z] && add == true) {
                var nextPlatformWidth;
                nextPlatformWidth = Phaser.Math.Between(options.platformSizeRange[0], options.platformSizeRange[1]);
                this.addPlatform(nextPlatformWidth, game.config.width + nextPlatformWidth / 2, platformY, z);
                
            } else if (add == false && added == false) {
                this.addPlatform(100, game.config.width + 100 / 2, platformY, z);
                added = true;
                this.player.setBounce(0);
                movePlatforms = true;
            } else if (movePlatforms == true) {
                this.platformA[0].y = (game.config.height / 2) + 200 * Math.sin(this.platformA[0].x / 100);
                this.platformA[1].y = (game.config.height / 2) + 200 * Math.sin(this.platformA[0].x / 100 - Math.PI);
                this.platformA[2].y = (game.config.height / 2) + 200 * Math.sin(this.platformA[0].x / 100);
                this.platformA[3].y = (game.config.height / 2) + 200 * Math.sin(this.platformA[0].x / 100 - Math.PI);
                //this.platformA[4].y = (game.config.height / 2) + 200 * Math.sin(this.platformA[0].x / 100);
            }

        }
            
        }


        gameScene.create = function()
        {

            this.time.addEvent({ delay: 8000, callback: showSky, callbackScope: this, loop: false });

            this.time.addEvent({ delay: 145000, callback: upsideDown, callbackScope: this, loop: false });


            this.time.addEvent({ delay: 25000, callback: showBomb, callbackScope: this, loop: true });
            this.time.addEvent({ delay: 500, callback: showStars, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 1500, callback: starsMove, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 42000, callback: hideSky, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 62000, callback: showSky, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 57000, callback: goStart, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 66000, callback: goEnd, callbackScope: this, loop: false });

            this.time.addEvent({ delay: 104000, callback: goStart, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 113000, callback: goEnd, callbackScope: this, loop: false });

            this.time.addEvent({ delay: 161000, callback: goStart, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 170000, callback: goEnd, callbackScope: this, loop: false });

            //this.time.addEvent({ delay: 60000, callback: goStart, callbackScope: this, loop: false });

            this.time.addEvent({ delay: 89000, callback: hideSky, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 109000, callback: showSky, callbackScope: this, loop: false });
            //this.time.addEvent({ delay: 60000, callback: goStart, callbackScope: this, loop: false });


            this.time.addEvent({ delay: 146000, callback: hideSky, callbackScope: this, loop: false });
            this.time.addEvent({ delay: 166000, callback: showSky, callbackScope: this, loop: false });

            camera = this.cameras.main;

            this.platformGroup = new Array(3);
            this.platformPool = new Array(3);


            this.platformGroup[0] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformPool[0].add(platform)
                }
            });

            this.platformPool[0] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformGroup[0].add(platform)
                } 
            });

            this.platformGroup[1] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformPool[1].add(platform)
                }
            });

            this.platformPool[1] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformGroup[1].add(platform)
                } 
            });

            this.platformGroup[2] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformPool[2].add(platform)
                }
            });

            this.platformPool[2] = this.add.group({
                removeCallback: function(platform) {
                    platform.scene.platformGroup[2].add(platform)
                } 
            });


            this.starGroup = this.add.group({
                removeCallback: function(star) {
                    star.scene.starPool.add(star)
                }
            });

            this.starPool = this.add.group({
                removeCallback: function(star) {
                    star.scene.starGroup.add(star)
                } 
            });

            

            //this.physics.world.setFPS(30);
            this.player = this.physics.add.sprite(game.config.width / 2 - 80, dropHeight, 'dude').setScale(1.5);
            this.player.setGravityY(options.gravity);

            

            this.player.setBounce(0.4);
            this.player.setCollideWorldBounds(true);
            this.physics.add.existing(ground, true);
            this.physics.add.collider(this.player, ground);

            this.addPlatform(0, 0, 0, 0);
            this.addPlatform(0, 0, 0, 1);
            this.addPlatform(0, 0, 0, 2);

        


            for (x = 0; x < 3; x++) {
            this.physics.add.collider(this.player, this.platformGroup[x]);
            }

            this.physics.add.overlap(this.player, this.starGroup, collectStar, null, this);
            

            
            this.anims.create({
                key: 'running',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 2 }),
                frameRate: 7.5,
                repeat: -1
            });

            this.anims.create({
                key: 'bombed',
                frames: this.anims.generateFrameNumbers('dude-bombed', { start: 0, end: 2 }),
                frameRate: 7.5,
                repeat: -1
            });


            this.player.anims.play('running');
        
            this.initialTime = 180;
    
            scoreText = this.add.text(game.config.width / 2, 60, 'Score: 0', { fontFamily: "VCR", fontSize: '16pt' }).setOrigin(0.5);
            text = this.add.text(game.config.width / 2, 32, formatTime(this.initialTime), { fontFamily: "VCR", fontSize: '16pt' }).setOrigin(0.5);

            this.time.addEvent({ delay: 1000, callback: timerEvent, callbackScope: this, loop: true });



             camera.shake(1000, 0.008);
             tsCamera.shake(1000, 0.008);


            



            this.input.on('pointerdown', () => {
                this.player.setVelocityY(-300);
            });
        
            
            
        }   

        gameScene.addPlatform = function(platformWidth, posX, posY, platformIndex) {
                 let platform;
                 if (add == false) {
                    this.platformA = new Array(5);
                    for (x = 0; x < 4; x++) {
                    this.platformA[x] = this.physics.add.sprite(posX + ((x + 1) * 220), game.config.height / 2, 'platform');
                    this.platformA[x].setImmovable(true);
                    this.platformA[x].setFrictionX(0);
                    this.platformA[x].body.friction.y = 1;
                    this.platformA[x].setVelocityX(-options.speed);
                    this.platformGroup[platformIndex].add(this.platformA[x]);
                    this.platformA[x].displayWidth = 200;
                    }

                 }
                 else if (this.platformPool[platformIndex].getLength()) {
                    platform = this.platformPool[platformIndex].getFirst();
                    platform.x = posX;
                    platform.y = posY;
                    platform.active = true;
                    platform.visible = true;
                    this.platformPool[platformIndex].remove(platform);
                    platform.displayWidth = platformWidth;

                  
                 } else {
                    platform = this.physics.add.sprite(posX, posY, 'platform');
                    platform.setImmovable(true);
                    platform.setFrictionX(0);
                    platform.setVelocityX(-options.speed);
                    this.platformGroup[platformIndex].add(platform);
                    platform.displayWidth = platformWidth;

                 }

                nextPlatformDistance[platformIndex] = Phaser.Math.Between(options.spawnRange[0], options.spawnRange[1]);
                var offset = Phaser.Math.Between(-platformWidth / 2, platformWidth / 2);
                var randomChoice = Phaser.Math.Between(1, 100)
                    
                        if (randomChoice <= 70) {
                        for (x = 0; x < Phaser.Math.Between(1, 4); x++) {
                        var star = this.physics.add.sprite(posX + Phaser.Math.Between(-platformWidth / 2, platformWidth / 2), posY - 20, 'star');
                        star.setImmovable(true);
                        star.setVelocityX(-options.speed);
                        if (randomChoice <= 5) {
                            star.setTint(0xFF0000);
                        }

                        this.starGroup.add(star);
                        }
                    }
                    

                    if (randomChoice <= 25) {
                        let floorStar = this.physics.add.sprite(posX + offset, 580, 'star');
                        floorStar.setImmovable(true);
                        floorStar.setVelocityX(-options.speed);
                        this.starGroup.add(floorStar);
                    }
        }
            
    
        function checkPlaying() {
            if (instructionsScene.music.seek > 0) {
                            this.time.removeAllEvents();
                            instructionsScene.scene.start(gameScene);
                    }
        }
    
        function formatTime(seconds)
        {
            var minutes = Math.floor(seconds/60);
            var partInSeconds = seconds%60;
            partInSeconds = partInSeconds.toString().padStart(2,'0');
            return `${minutes}:${partInSeconds}`;
        }
    
        
        function timerEvent ()
        {
            if (this.initialTime == 0)
            {
                scoreText.visible = false;
                text.visible = false;
                this.time.removeAllEvents();
            } else {

            if (this.initialTime == 2) {
                this.scene.launch(gameOverScene);
            }
            
            this.initialTime -= 1; // One second
            text.setText(formatTime(this.initialTime));
            }
        }

        

        gameOverScene.create = async function() {

            leaderBoard = this.plugins.get('rexfirebaseplugin').add.leaderBoard({
            root: 'scores',
            // timeFilters: false,
            // timeFilterType: 'year',
            // pageItemCount: 100,
            // boardID: undefined,
            // tag: undefined
            });


            

            retrieveScores();

            

 

            this.backdrop = this.add.graphics({ fillStyle: { color: 0x000000} }).fillRoundedRect(290, 38, 395, 630, 15);
            this.backdrop.alpha = 0;
            this.gameoversign = this.add.image(game.config.width / 2, game.config.height / 2, 'gameoversign').setScale(0.8);

            await timer(2000);
            
            while (this.gameoversign.y > 100) {
                scaleIndex -= 0.006;
                
                this.backdrop.alpha += 0.013;
                this.gameoversign.y -= 4;
                this.gameoversign.setScale(scaleIndex);
                await timer(16);
            }

            this.scene.pause(animateScene);
            this.scene.pause(gameScene);

            var usernamePotential = localStorage.getItem('userID');
            var userExists = false;

            if (usernamePotential == null) {
                userExists = false;
            } else {
            for (i = 0; i < scoresRetrieved.length; i++) {
                if (scoresRetrieved[i].userID == usernamePotential && userExists == false) {
                    userExists = true;
                    usernameReal = usernamePotential;
                    this.scene.launch(leaderboardScene);
                }
            }
        }

            if (userExists == false) {
                newUser = true;
                this.scene.launch(setNameScene);
            }
        
        
        }

        async function retrieveScores() {
            scoresRetrieved = await leaderBoard.loadFirstPage();

            while (!(leaderBoard.isLastPage)) {
                scoresRetrieved = scoresRetrieved.concat(await leaderBoard.loadNextPage());
            }
        }
        

        function showStars() {

            fallingStars = this.physics.add.group({
                key: 'star',
                repeat: 7,
                setXY: { x: game.config.width / 2 - 100, y: 0, stepX: 50 }
            });

            fallingStars.children.iterate(function (child) {

                //  Give each star a slightly different bounce
                child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                child.setGravityY(800);
            });

            this.physics.add.overlap(gameScene.player, fallingStars, collectStar, null, this);
            for (x = 0; x < 3; x++) {
            this.physics.add.collider(fallingStars, gameScene.platformGroup[x]);
            }
            this.physics.add.collider(fallingStars, ground);


 
        }

        function showBomb() {

        var dropOrSide = Phaser.Math.RND.pick([1, 2]);

        if (dropOrSide == 1) {
        this.fallingBombs = this.physics.add.group({
            key: 'bomb',
            repeat: 4,
            setXY: { x: game.config.width / 2 - 80, y: 0, stepX: 100 },
        });

        this.fallingBombs.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.6, 1.0));
            child.setGravityY(500);
            child.setScale(1.5);
        });
    } else {
        this.fallingBombs = this.physics.add.group({
            key: 'bomb',
            repeat: 4,
            setXY: { x: game.config.width, y: 0, stepY: 100 },
        });

        this.fallingBombs.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.6, 1.0));
            child.setGravityY(500);
            child.setVelocityX(2 * (-options.speed))
            child.setScale(1.5);
        });
    }

    
        this.physics.add.overlap(gameScene.player, this.fallingBombs, hitBomb, null, this);
        for (x = 0; x < 3; x++) {
        this.physics.add.collider(this.fallingBombs, gameScene.platformGroup[x]);
        }

        this.physics.add.collider(this.fallingBombs, ground);

        this.time.addEvent({ delay: 4000, callback: moveObject, callbackScope: this, loop: false });


}


        


        function moveObject() {
            this.fallingBombs.children.iterate(function (child) {
                child.setVelocityX(-options.speed);
                });
        }



        function starsMove() {
            fallingStars.children.iterate(function (child) {
                child.setVelocityX(-options.speed);
                });
        }

        function collectStar (player, star)
        {
            star.disableBody(true, true);

            //  Add and update the score
            if (star.isTinted) {
                score += 10;
            } else {
                score += 2;
            }
            scoreText.setText('Score: ' + score);

        }

        function goStart() {
            add = false;
        }

        function goEnd(){
            add = true;
            added = false;
            this.time.addEvent({ delay: 8000, callback: goStop, callbackScope: this, loop: false });

        }

        function goStop() {
            movePlatforms = false;
            gameScene.player.setBounce(0.4);
        }

        function hitBomb (player, bomb) {
            bomb.disableBody(true, true);

            gameScene.player.anims.play('bombed');
            //gameScene.player.setTint('#c23838');
            async function stopFlashingRed() {
                await timer(1000);
                gameScene.player.anims.play('running');
                //gameScene.player.clearTint();
            }
            stopFlashingRed();
            score -= 10;
            scoreText.setText('Score: ' + score);
        }
        
        function upsideDown() {
            camera.rotateTo(Math.PI, false, 10000);
            tsCamera.rotateTo(Math.PI, false, 10000);            
        }

        function upsideUp() {
            camera.rotateTo(0, false, 1000);
            tsCamera.rotateTo(0, false, 1000); 
        }
        

        function showSky () {
            async function show() {
            while (sky.alpha < 1) {
                sky.alpha += 0.1;
                await timer(30);
            };
        }
        show();
        }

        function hideSky () {
            async function hide() {
            while (sky.alpha > 0) {
                sky.alpha -= 0.1;
                await timer(30);
            };
        }
        hide();
        }

        setNameScene.create = function() {

            this.maximumChars = 10;


                this.add.text(game.config.width / 2, 200, 'ENTER A NAME TO ADD YOUR', { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
                this.add.text(game.config.width / 2, 220, 'HIGH SCORE TO THE LEADERBOARD:', { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
                this.add.text(game.config.width / 2, 380, 'YOUR NAME WILL BE SAVED FOR NEXT TIME', { fontFamily: "VCR", fontSize: '12pt'}).setOrigin(0.5);
                this.next = this.add.text(game.config.width / 2, 500, 'NEXT →', { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
                
                this.takenError = this.add.text(game.config.width / 2, 420, 'SORRY, THAT NAME IS ALREADY IN USE', { fontFamily: "VCR", fontSize: '12pt', color: '#FF0000'}).setOrigin(0.5);
                this.takenError.visible = false;

                inputText = this.add.rexInputText(game.config.width / 2, 300, 150, 30, {
                    type: 'text',
                    placeholder: 'NICKNAME',
                    fontSize: '20px',
                    fontFamily: 'VCR',
                    border: 0.5,
                    borderColor: '#ffffff'
        })

            inputText.on('textchange', function(inputText, e){
                this.takenError.visible = false;
                inputText.setText(inputText.text.substr(0, previousTextLength + 1).toUpperCase());
                if (inputText.text.length > this.maximumChars) {
                    inputText.setText(inputText.text.substr(0, this.maximumChars));
                }
                var c = inputText.text.charAt(inputText.text.length - 1);
                if (!((c >= 'A' && c <= 'Z') || (c >= '0' && c <= '9') || (c == "_"))) {
                    inputText.setText(inputText.text.substr(0, inputText.text.length - 1));
                } 

                previousTextLength = inputText.text.length;
             }, this);

            this.next.setInteractive({ useHandCursor: true });
            this.next.on('pointerdown', () => {
            for (i = 0; i < scoresRetrieved.length; i++) {
                 if (inputText.text == scoresRetrieved[i].userID) {
                     this.takenError.visible = true;
                 }
            }
            if (this.takenError.visible == false) {
                usernameReal = inputText.text;
                localStorage.setItem('userID', usernameReal);
                this.scene.start(leaderboardScene);
            }
             })

        }

        leaderboardScene.create = async function() {

            this.add.text(game.config.width / 2, 160, 'LEADERBOARD', { fontFamily: "VCR", fontSize: '30pt'}).setOrigin(0.5);

            leaderBoard.setUser(usernameReal);

            var highScore;

            if (newUser == false) {
                highScore = await leaderBoard.getScore();
                highScore = highScore.score;
            }

            if (newUser == true || score > highScore) {
                this.add.text(game.config.width / 2, 270, 'NEW HIGH SCORE!', { fontFamily: "VCR", fontSize: '18pt'}).setOrigin(0.5);
                highScore = score;
                await leaderBoard.post(score);
            }

            var rank = await leaderBoard.getRank();
            rank = rank.rank + 1

            this.add.text(game.config.width / 2, 200, 'YOUR SCORE: ' + score, { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
            this.add.text(game.config.width / 2, 220, 'HIGH SCORE: ' + highScore, { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
            this.add.text(game.config.width / 2, 240, 'RANK: ' + rank, { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);

            scoresRetrieved = await leaderBoard.loadFirstPage();

            while (!(leaderBoard.isLastPage)) {
                scoresRetrieved = scoresRetrieved.concat(await leaderBoard.loadNextPage());
            }

            


            var newCellObject = function (scene, cell) {
            // var bg = scene.add.graphics()
            //     .fillStyle(0x000000)
            //     .fillRect(2, 2, 310 - 2, 40 - 2);
            var txtRank = scene.add.text(5, 5, (cell.index + 1) + '.', {fontFamily: "VCR", fontSize: '14pt'});
            var txtUsername = scene.add.text(50, 5, scoresRetrieved[cell.index].userID, {fontFamily: "VCR", fontSize: '14pt'});
            var txtScore = scene.add.text(240, 5, scoresRetrieved[cell.index].score, {fontFamily: "VCR", fontSize: '14pt'});
            var container = scene.add.container(0, 0, [txtRank, txtUsername, txtScore]);
            return container;
        }

        var onCellVisible = function (cell) {
            cell.setContainer(newCellObject(this, cell));
            //console.log('Cell ' + cell.index + ' visible');
        };
        var table = this.add.rexGridTable(game.config.width / 2, 465, 310, 335, {
            cellWidth: 310,
            cellHeight: 40,
            cellsCount: scoresRetrieved.length,
            columns: 1,
            cellVisibleCallback: onCellVisible.bind(this),
            clamplTableOXY: false
        });

        // draw bound
        // this.add.graphics()
        //     .lineStyle(3, 0xff0000)
        //     .strokeRectShape(table.getBounds());

        //drag table content
        table.scroller = this.plugins.get('rexscrollerplugin').add(table, {
                bounds: [
                    table.bottomTableOY,
                    table.topTableOY
                ],
                value: table.topTableOY,
                slidingDeceleration: 10000,
                backDeceleration: 2000,
                valuechangeCallback: function (newValue) {
                    table.setTableOY(newValue).updateTable();
                }
            });

        this.table = table;

            this.add.text(game.config.width / 2, 650, '↓', { fontFamily: "VCR", fontSize: '14pt'}).setOrigin(0.5);


            this.playAgain = this.add.text(game.config.width / 2, 675, 'BEAT YOUR SCORE', { fontFamily: "VCR", fontSize: '16pt', backgroundColor: '#ba0000'}).setOrigin(0.5);
            this.playAgain.setInteractive({ useHandCursor: true });
            this.playAgain.on('pointerdown', () => {location.reload()});






            // this.backButton = this.add.text(game.config.width / 2, 630, 'BACK', { fontFamily: "VCR", fontSize: '16pt'}).setOrigin(0.5);
            // this.backButton.setInteractive({ useHandCursor: true });
            // this.backButton.on('pointerdown', () => {leaderboardScene.scene.remove(leaderboardScene)});

            // var displayNumber = 10;
	        // var spacing = 128;

	        // for (let i = 0; i < 10; i++)
	        // {
            //     if (i < scoresRetrieved.length) {
		    //     var num = this.add.text(300, spacing, `${i + 1}.`, {fontFamily: 'VCR', fontSize: '20px'}).setOrigin(0, 0.5)

			//     var scoreItem = scoresRetrieved[i]

			//     var name = this.add.text(num.x + 30, spacing, scoreItem.userID, {fontFamily: 'VCR', fontSize: '20px'}).setOrigin(0, 0.5)
	
			//     this.add.text(name.x + 300, spacing, scoreItem.score.toString(), {fontFamily: 'VCR', fontSize: '20px'}).setOrigin(0, 0.5)	
		    //     spacing += 20
            //     }
	        //     }
            

            

        }


    
    
    </script>
    
    </body>
    </html>